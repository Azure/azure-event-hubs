# Using This Sample

This sample was developed for use with Visual Studio 2017 and the Service Fabric SDK.

You can find the NuGet package for Service Fabric Studio at https://www.nuget.org/packages/Microsoft.Azure.EventHubs.ServiceFabricProcessor/
but it already appears in the sample as a dependency and you should not need to download or install it manually.

## Install the Service Fabric SDK

Instructions for installing the Service Fabric SDK are [here](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-get-started)

## Open the Solution

* The Service Fabric deployment features of Visual Studio will not work unless Visual Studio is started as admin.

* Once Visual Studio is running as admin, open the solution file, SFProcessorSample.sln.

* In file Stateful1.cs, replace the placeholder value of eventHubConnectionString with the connection string of your event hub.
This needs to be an Event Hub native connection string, which is of the form

> Endpoint=sb://yourEventHubNamespace.servicebus.windows.net/;SharedAccessKeyName=yourKeyName;SharedAccessKey=yourKeyBase64Encoded;EntityPath=yourEventHub

Service Fabric Processor also works with event hubs in national clouds, and for those the domain name of the Endpoint
will be servicebus.something.else, varying according to which national cloud, but it will always contain "servicebus".
IoT-style connection strings are not supported yet. Service Fabric Processor fully supports event hubs which are
embedded in IoT deployments; it just requires going to Portal and getting the native connection string for
the event hub. If it does not have the EntityPath= clause at the end, you can add it manually. Service Fabric Processor
will not work without it.

* Service Fabric Processor requires that the Service Fabric service have the same number of partitions as the
event hub. As supplied, the sample is configured for four partitions, so it will only work with a four-partition
event hub. To change the partition count, edit the XML files under ApplicationParameters. The partition count
also appears in ApplicationPackageRoot\\ApplicationManifest.xml, but that value seems to be overridden by
the parameter files.

* Check the dependencies of Stateful1. If the Service Fabric package versions do not match the SDK version that
is installed, you will probably not be able to deploy the sample service to a local cluster.

## Running the Sample

The easiest way to watch the sample in action is to let Visual Studio deploy it to the local cluster and use
VS to watch the tracing messages generated by Service Fabric Processor and the sample code. If the Service Fabric
versions match, you can just hit F5 to start the deployment process.

To watch the tracing messages:

* Open the Diagnostic Events window: View\Other Windows\Diagnostic Events. It is automatically configured to
display traces from Service Fabric and the sample service.

* To see the traces generated by Service Fabric Processor, click on the gear and add
Microsoft-Azure-EventHubs-ServiceFabricProcessor to the list of ETW providers.

By default, the sample generates a trace every 100 events on each partition. For example:

> SAMPLE IEventProcessor.ProcessEventsAsync for 1 got 9 total 120900 last sequence number 16289330 lastbody thu2-2-60620

* "for 1": event hub partition 1

* "got 9": there were 9 events passed to ProcessEventsAsync in this call

* "total 120900": the sample has received 120900 events on partition 1 so far

* "last sequence number 16289330": the sequence number of this event

* "lastbody thu2-2-60620": the body of this event (the sample assumes that event bodies are UTF-8 strings)

## Files of Interest

The most important part of the sample is SampleEventProcessor.cs, which is a sample implementation of
IEventProcessor.

Stateful1.cs shows how to instantiate ServiceFabricProcessor, start event consumption, and handle shutdown.

See the Programmer's Guide for detailed information.
